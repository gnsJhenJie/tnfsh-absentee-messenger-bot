#This is TNFSH absent query Bot Main Program
#gnsJhenJie 2020 Copyright
#Author: gnsJhenJie (github.com/gnsJhenJie)

import os
import io
import sys
import json
from datetime import datetime, timedelta, date
import requests
from flask import Flask, request
import time
import pandas
import socket
import random
import pyshorteners
from pyshorteners import Shorteners  
#Dymanic link ç¸®ç¶²å€å¥—ä»¶
from python_firebase_url_shortener.url_shortener import UrlShortener
#Put your Firebase API Key below. Using system variable is recommended.
#æ”¾ç½®ä½ çš„Firebase API Key åœ¨ä¸‹æ–¹ å»ºè­°æ”¹ç”¨ç’°å¢ƒè®Šæ•¸
firebase_api_key = 'FIREBASE_API_KEY'
url_shortener = UrlShortener(firebase_api_key, 'tfabsent')

#firebase:
# å¼•ç”¨firebaseå¿…è¦å¥—ä»¶
# import firebase packages
import firebase
import firebase_admin
from firebase_admin import credentials
from firebase_admin import firestore
# Attach Firebase json credentials by PATH
# å¼•ç”¨ç§å¯†é‡‘é‘° Firebase json credentials
# path/to/serviceAccount.json è«‹ç”¨è‡ªå·±å­˜æ”¾çš„è·¯å¾‘
cred = credentials.Certificate('PATH')
# åˆå§‹åŒ–firebaseï¼Œæ³¨æ„ä¸èƒ½é‡è¤‡åˆå§‹åŒ–
firebase_admin.initialize_app(cred)
# åˆå§‹åŒ–firestore
db = firestore.client()
# firebase Firestore Variables
# firebase firestore åƒæ•¸
user_info_collection_name = "user_info"
user_info_path = "user_info"
user_info_collection_ref = db.collection(user_info_path)

total_list_collection_name = 'total_list'
total_list_collection_path = 'total_list'
total_list_collection_ref = db.collection(total_list_collection_path)

transfer_name = 'transfer'
transfer_path = 'transfer'
transfer_ref = db.collection(transfer_path)

#Crawl web packages
import urllib.request, urllib.parse, urllib.error
from bs4 import BeautifulSoup
# Import Google Application Credentials json by PATH
# å°å…¥Google Application Credentials jsonæª”çš„æª”æ¡ˆè·¯å¾‘
os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="PATH"


app = Flask(__name__)

@app.route('/', methods=['GET'])
def verify():
    # when the endpoint is registered as a webhook, it must echo back
    # the 'hub.challenge' value it receives in the query arguments
    # Verify Token is generated by Facebook Please set it to environmental variable
    # Verify Token ç‚ºFacebookæä¾›çš„Token è«‹å°‡å…¶è¨­ç‚ºç’°å¢ƒè®Šæ•¸
    if request.args.get("hub.mode") == "subscribe" and request.args.get("hub.challenge"):
        if not request.args.get("hub.verify_token") == os.environ["VERIFY_TOKEN"]:
            return "Verification token mismatch", 403
        return request.args["hub.challenge"], 200

    return "Hello world", 200


@app.route('/', methods=['POST'])
def webhook():

    # endpoint for processing incoming messaging events
    # è™•ç†æµå…¥è¨Šæ¯

    data = request.get_json()
    log(data)  # you may not want to log every incoming message in production, but it's good for testing 

    if data["object"] == "page":

        for entry in data["entry"]:
            for messaging_event in entry["messaging"]:

                if messaging_event.get("message"):  # someone sent us a message æŸäººç™¼é€äº†è¨Šæ¯
                    is_text = False
                    sender_id = messaging_event["sender"]["id"]        # the facebook ID of the person sending you the message å‚³é€è€…Facebook ID
                    try:  #Check if it is a text message... åˆ¤æ–·æ˜¯å¦ç‚ºæ–‡å­—è¨Šæ¯
                        message_text = messaging_event["message"]["text"]  # the message's text è¨Šæ¯æ–‡å­—éƒ¨åˆ†
                        is_text = True
                    except:
                        message_text = 'QAQ' # If the message is not based on text (sticker, audio, image, etc) è‹¥éæ–‡å­—è¨Šæ¯ (è²¼åœ–,éŸ³æª”,åœ–åƒ...)
                        is_text = False
                    is_member_ed = bool()
                    try:  #Check if it is a member, if true record its info å˜—è©¦æ“·å–è³‡æ–™åº«ä¸­çš„è³‡è¨Š
                        doc_ref = user_info_collection_ref.document(sender_id)
                        docs = doc_ref.get()
                        docdict = docs.to_dict()
                        tnfsh_class = format(docdict['tnfsh_class'])
                        tnfsh_number = format(docdict['tnfsh_number'])
                        Created_time = format(docdict['Created_time'])
                        nickname = format(docdict['nickname'])
                        PS = format(docdict['PS'])
                        Last_changed_time = format(docdict['Last_changed_time'])
                        fb_name = format(docdict['fb_name'])
                        fb_first_name = format(docdict['fb_first_name'])
                        fb_last_name = format(docdict['fb_last_name'])
                        pss_win = format(docdict['pss_win'])
                        pss_lose = format(docdict['pss_lose'])
                        pss_draw = format(docdict['pss_draw'])
                        is_member_ed = True
                    except:  #Not a member éæœƒå“¡
                        is_member_ed = False 
                        
                    if is_member_ed and is_text:
                        msg = message_text.lower().replace("^","**",3).replace("ï¼‹","+",10).replace("ï¼","-",10).replace('ï¼Š','*',10).replace('ï¼','/',10).replace('ï¼ˆ','(',6).replace('ï¼‰',')',6).replace('Ã·','/',5).replace('Ã—','*',5)
                        if msg == 'hi':
                            radm = random.randint(1,2)
                            if radm == 1:
                                message_to_send = "Hi, " + nickname
                            elif radm == 2:
                                message_to_send = "Hello, " + nickname
                        elif msg == 'q' or msg == 'æŸ¥è©¢æœ€è¿‘ç¼ºå¸­' or msg == 'æŸ¥è¨Šæœ€è¿‘ç¼ºå¸­':  #query these 2 days 
                            date_today = datetime.now().date().strftime("%Y-%m-%d")
                            date_p1 = (datetime.now() + timedelta(days = -1)).strftime("%Y-%m-%d")
                            date_p2 = (datetime.now() + timedelta(days = -2)).strftime("%Y-%m-%d")
                            #Check today æª¢æŸ¥ä»Šæ—¥ç¼ºå¸­
                            count_absent_today, count_late_today, count_leave_today = absent_query(tnfsh_class, tnfsh_number, date_today)
                            #Check p1 day æª¢æŸ¥æ˜¨æ—¥ç¼ºå¸­
                            count_absent_p1, count_late_p1, count_leave_p1 = absent_query(tnfsh_class, tnfsh_number, date_p1)
                            #Check p2 day æª¢æŸ¥å‰å¤©ç¼ºå¸­
                            count_absent_p2, count_late_p2, count_leave_p2 = absent_query(tnfsh_class, tnfsh_number, date_p2)
                            #Deal message_to_send
                            message_to_send = '<æ‚¨çš„æœ€è¿‘ç¼ºå¸­>\n'
                            if count_absent_today == 0:
                                message_to_send += 'æŸ¥ç„¡æœ¬æ—¥ç¼ºå¸­\n'
                            else:
                                message_to_send += 'ä½ ä»Šå¤©å…±ç¼ºå¸­'+str(count_absent_today)+'ç¯€èª²\n'
                            if count_late_today > 0:
                                message_to_send += 'ä½ ä»Šå¤©å…±é²åˆ°'+str(count_late_today)+'ç¯€èª²\n'
                            if count_leave_today > 0:
                                message_to_send += 'ä½ ä»Šå¤©å…±æ—©é€€'+str(count_leave_today)+'ç¯€èª²\n'
                            if count_absent_p1 == 0:
                                message_to_send += 'æŸ¥ç„¡æ˜¨å¤©ç¼ºå¸­\n'
                            else:
                                message_to_send += 'ä½ æ˜¨å¤©å…±ç¼ºå¸­'+str(count_absent_p1)+'ç¯€èª²\n'
                            if count_late_p1 > 0:
                                message_to_send += 'ä½ æ˜¨å¤©å…±é²åˆ°'+str(count_late_p1)+'ç¯€èª²\n'
                            if count_leave_p1 >0:
                                message_to_send += 'ä½ æ˜¨å¤©å…±æ—©é€€'+str(count_leave_p1)+'ç¯€èª²\n'
                            if count_absent_p2 == 0:
                                message_to_send += 'æŸ¥ç„¡å‰å¤©ç¼ºå¸­\n'
                            else:
                                message_to_send += 'ä½ å‰å¤©å…±ç¼ºå¸­'+str(count_absent_p2)+'ç¯€èª²\n'
                            if count_late_p2 > 0:
                                message_to_send += 'ä½ å‰å¤©å…±é²åˆ°'+str(count_late_p2)+'ç¯€èª²\n'
                            if count_leave_p2 > 0:
                                message_to_send += 'ä½ å‰å¤©å…±æ—©é€€'+str(count_leave_p2)+'ç¯€èª²\n'
                            if count_absent_today + count_late_today + count_leave_today + count_absent_p1 + count_late_p1 + count_leave_p1 + count_absent_p2 + count_late_p2 + count_leave_p2 >0 :
                                message_to_send += 'å¿«å»çœ‹çœ‹å“ªç¯€èª²è¢«è¨˜å§!\n'
                                message_to_send += shorten_url('https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+date_p2+'&end='+date_today+'&class='+tnfsh_class+'&num='+tnfsh_number)
                        elif msg == 'qw' or msg == 'æŸ¥è©¢æœ¬é€±ç¼ºå¸­':
                            weekday = date.today().isoweekday()   
                            count_absent_total, count_late_total, count_leave_total = absent_query_period(tnfsh_class, tnfsh_number, (datetime.now() + timedelta(days = -weekday+1)).strftime("%Y-%m-%d"), datetime.now().date().strftime("%Y-%m-%d"))                            
                            message_to_send = '<æ‚¨çš„æœ¬é€±ç¼ºå¸­>\n'
                            if count_absent_total == 0:
                                message_to_send += 'æŸ¥ç„¡æœ¬é€±ç¼ºå¸­\n'
                            else:
                                message_to_send += 'æœ¬é€±å…±ç¼ºå¸­'+str(count_absent_total)+'ç¯€\n'
                            if count_late_total > 0:
                                message_to_send += 'æœ¬é€±å…±é²åˆ°'+str(count_late_total)+'ç¯€\n'
                            if count_leave_total > 0:
                                message_to_send += 'æœ¬å‘¨å…±æ—©é€€'+str(count_leave_total)+'ç¯€\n'
                            if count_absent_total + count_late_total + count_leave_total > 0:
                                message_to_send += 'å¿«å»çœ‹çœ‹å“ªç¯€èª²è¢«è¨˜å§!\n'
                                message_to_send += shorten_url('https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+(datetime.now() + timedelta(days = -weekday+1)).strftime("%Y-%m-%d")+'&end='+datetime.now().date().strftime("%Y-%m-%d")+'&class='+tnfsh_class+'&num='+tnfsh_number)
                        elif msg[0] == 'q' and len(msg) == 17: #Query for specific date æŸ¥è©¢æŒ‡å®šå€é–“ç¼ºå¸­
                            legal = False
                            try:
                             if  2101 > int(msg[1:5]) > 1999 and 13 > int(msg[5:7]) > 0 and 32 > int(msg[7:9]) > 0 and 2101 > int(msg[9:13]) > 1999 and int(msg[9:13]) >= int(msg[1:5]) and 13 > int(msg[13:15]) > 0 and 32 > int(msg[15:17]) > 0:
                                legal = True
                            except:
                                legal = False
                            if legal == True:
                                count_absent_total, count_late_total, count_leave_total = absent_query_period(tnfsh_class, tnfsh_number, msg[1:5] + '-' + msg[5:7] + '-' + msg[7:9] , msg[9:13] + '-' + msg[13:15] + '-' + msg[15:17])                            
                                message_to_send = '<æŸ¥è©¢æŒ‡å®šå€é–“>\n'
                                if count_absent_total == 0:
                                    message_to_send += 'æŸ¥ç„¡æœ¬å€é–“ç¼ºå¸­\n'
                                else:
                                    message_to_send += 'æœ¬å€é–“å…±ç¼ºå¸­'+str(count_absent_total)+'ç¯€\n'
                                if count_late_total > 0:
                                    message_to_send += 'æœ¬å€é–“é²åˆ°'+str(count_late_total)+'ç¯€\n'
                                if count_leave_total > 0:
                                    message_to_send += 'æœ¬å€é–“å…±æ—©é€€'+str(count_leave_total)+'ç¯€\n'
                                if count_absent_total + count_late_total + count_leave_total > 0:
                                    message_to_send += 'å¿«å»çœ‹çœ‹å“ªç¯€èª²è¢«è¨˜å§!\n'
                                    message_to_send += shorten_url('https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+msg[1:5] + '-' + msg[5:7] + '-' + msg[7:9]+'&end='+msg[9:13] + '-' + msg[13:15] + '-' + msg[15:17]+'&class='+tnfsh_class+'&num='+tnfsh_number)
                                send_message(sender_id, message_to_send)
                                message_to_send = 'Btw, è«‹ç¢ºèªä¸€ä¸‹ä½ è¼¸å…¥çš„æ—¥æœŸæ˜¯ä¸æ˜¯éƒ½æ˜¯é€™å€‹ç­ç´šåº§è™Ÿ~~'
                            else:
                                pass
                        elif msg == 'help':
                            message_to_send = 'æŸ¥è©¢è¿‘ä¸‰æ—¥ç¼ºå¸­: q æˆ– æŸ¥è©¢æœ€è¿‘\næŸ¥è©¢æœ¬å‘¨ç¼ºå¸­: qw æˆ– æŸ¥è©¢æœ¬é€±\né‡è¨­ç­ç´šåº§è™Ÿ: cç­ç´šåº§è™Ÿ (e.g. c10101)\nè¨­å®šæš±ç¨±:ni+æš±ç¨± (e.g. niå¤©å ‚)\næŸ¥è©¢å€‹äººè¨­å®š:profile\né¡¯ç¤ºèª²è¡¨:course'
                            send_message(sender_id,message_to_send)
                            message_to_send = 'æŸ¥è©¢æŒ‡å®šå€é–“: q+èµ·å§‹çµæŸè¥¿å…ƒå¹´æœˆæ—¥\n(e.g. q2018010120190331)\nè¨­å®šæ˜ŸæœŸå¹¾è¦æ¨æ’­æ™šå®‰è¨Šæ¯:\nset+æ”¶æ¨æ’­çš„æ˜ŸæœŸå¹¾\n(e.g. æ˜ŸæœŸäºŒå››å…­æ—¥ set2467git)\né—œé–‰æé†’:set0'
                            send_message(sender_id, message_to_send)
                            message_to_send = 'ä¹Ÿå¯ä»¥è·Ÿæˆ‘say hi ã„›~~'
                            send_message(sender_id, message_to_send)
                            message_to_send = 'åƒæ˜¯1+1ä¹‹é¡ç°¡å–®çš„æ•¸å­¸æˆ‘å…¶å¯¦ä¹Ÿæœƒç®—!\næƒ³è·Ÿæˆ‘ç©éŠæˆ²çš„è©±å°±è¼¸å…¥gamehelpå§!'
                        elif msg == 'gamehelp' or msg == 'game help':
                            message_to_send = 'æƒ³è·Ÿæˆ‘ç©å‰ªåˆ€çŸ³é ­å¸ƒçš„è©±å°±ç›´æ¥å‡ºæ‹³å–”!\næŸ¥çœ‹å°æ±ºç´€éŒ„è¼¸å…¥:å‰ªåˆ€çŸ³é ­å¸ƒ æˆ– pss report'
                        elif msg == 'course' or msg == "æˆ‘çš„èª²è¡¨" or msg == "èª²è¡¨":
                            message_to_send = ""
                            send_image_message(sender_id, "https://tnfsh-absentee.web.app/courseTables/"+tnfsh_class+".jpeg")
                        elif msg == 'å‰ªåˆ€' or msg == 'scissors' or msg == u'âœ‚ï¸' or msg == u'âœŒï¸' or msg == u'âœŒğŸ»' or msg == u'âœŒğŸ¼' or msg == u'âœŒğŸ½' or msg == u'âœŒğŸ¾' or msg == u'âœŒğŸ¿':
                            radm = random.randint(1,10)
                            if radm <=3:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'æˆ‘å‡ºå‰ªåˆ€!\nå¹³æ‰‹~'
                                elif radmm == 2:
                                    message_to_send = 'å‰ªåˆ€!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = 'å¹³æ‰‹OuO'
                                elif radm == 3:
                                    message_to_send = 'å‰ªåˆ€:Scissors~\nå¹³æ‰‹:Draw~'
                                else:
                                    message_to_send = 'å°é¸šéµ¡å‡º....å‰ªåˆ€!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = "å¹³æ‰‹!"
                                pss_draw = str(int(pss_draw)+1)
                            elif radm<=8:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'çŸ³é ­~~\nå•¦å•¦å•¦~æˆ‘è´å•¦~'
                                elif radmm == 2:
                                    message_to_send = 'Stone!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = 'You are too VEGETABLE.'
                                elif radmm == 3:
                                    message_to_send = 'å°é¸šéµ¡å‡ºçŸ³é ­~~'
                                elif radmm == 4:
                                    message_to_send = 'ã„~çŸ³é ­!è´å•¦!'
                                elif radmm == 5:
                                    message_to_send = 'å«©!å°é¸šéµ¡éƒ½æ¯”ä½ æœƒç©~\næˆ‘å‡ºçŸ³é ­ä½ è¼¸å•¦!'
                                pss_lose = str(int(pss_lose)+1)
                            else:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'å¸ƒ!ä½ è´å•¦!\nç®—ä½ å²å®³'
                                elif radmm == 2:
                                    message_to_send = 'æˆ‘å‡ºå¸ƒ!\n...å°é¸šéµ¡è¼¸äº†QQ'
                                elif radmm == 3:
                                    message_to_send = 'Paper!å¹«ä½ åŠ 1åˆ†'
                                elif radmm == 4:
                                    message_to_send = 'å°é¸šéµ¡å‡ºå¸ƒ!æ­å–œä½ è´æƒ¹ã€‚'
                                elif radmm == 5:
                                    message_to_send = 'å¸ƒ!ä¸!æˆ‘è¼¸äº†'
                                pss_win = str(int(pss_win)+1)
                            new_record = dict()
                            new_record['tnfsh_class'] = tnfsh_class
                            new_record['tnfsh_number'] = tnfsh_number
                            new_record['fb_sender_id'] = sender_id
                            new_record['Created_time'] = Created_time
                            new_record['Last_changed_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                            new_record['nickname'] = nickname
                            new_record['PS'] = PS
                            new_record['fb_name'] = fb_name
                            new_record['fb_last_name'] = fb_last_name
                            new_record['fb_first_name'] = fb_first_name
                            new_record['pss_win'] = pss_win
                            new_record['pss_lose'] = pss_lose
                            new_record['pss_draw'] = pss_draw
                            doc_ref = db.collection("user_info").document(sender_id)
                            doc_ref.set(new_record)
                        elif msg == 'çŸ³é ­' or msg == 'stone' or msg == u'âœŠ' or msg == u'âœŠğŸ»' or msg == u'âœŠğŸ¼' or msg == u'âœŠğŸ½' or msg == u'âœŠğŸ¾' or msg == u'âœŠğŸ¿':
                            t = datetime.now().second
                            radm = random.randint(1,t+2)
                            if radm <=17:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'æˆ‘å‡ºå‰ªåˆ€!\nSo sad..'
                                elif radmm == 2:
                                    message_to_send = 'å‰ªåˆ€!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = 'é›£é@@'
                                elif radmm == 3:
                                    message_to_send = 'å‰ªåˆ€:Scissors~\nè¼¸äº†:Lose...'
                                elif radmm == 4:
                                    message_to_send = 'è¼¸äº†QQ\næˆ‘å‡ºå‰ªåˆ€...'
                                else:
                                    message_to_send = 'å°é¸šéµ¡å‡º....å‰ªåˆ€!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = "ç®—ä½ å²å®³!"
                                pss_win = str(int(pss_win)+1)
                            elif radm<=24:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'çŸ³é ­~~\nå¹³æ‰‹ã„ã„'
                                elif radmm == 2:
                                    message_to_send = 'Stone!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = '~Draw~'
                                elif radmm == 3:
                                    message_to_send = 'å°é¸šéµ¡å‡ºçŸ³é ­~~'
                                elif radmm == 4:
                                    message_to_send = 'çŸ³é ­!å¹³æ‰‹~\né˜¿ä¸å°±å¥½æ£’æ£’!'
                                elif radmm == 5:
                                    message_to_send = 'å°é¸šéµ¡å‡ºçŸ³é ­~~\nå†ä¾†ä¸€æ¬¡å•Š!!'
                                pss_draw = str(int(pss_draw)+1)
                            else:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'å¸ƒ!ä½ è¼¸å•¦!\nç®—å°é¸šéµ¡å²å®³'
                                elif radmm == 2:
                                    message_to_send = 'æˆ‘å‡ºå¸ƒ!\n...å°é¸šéµ¡è´äº†'
                                elif radmm == 3:
                                    message_to_send = 'Paper!å«©!'
                                elif radmm == 4:
                                    message_to_send = 'å°é¸šéµ¡å‡ºå¸ƒ!æ­å–œä½ è¼¸æƒ¹~~'
                                elif radmm == 5:
                                    message_to_send = 'å¸ƒ!ä½ è¼¸äº†å“ˆå“ˆ~'
                                pss_lose = str(int(pss_lose)+1)
                            new_record = dict()
                            new_record['tnfsh_class'] = tnfsh_class
                            new_record['tnfsh_number'] = tnfsh_number
                            new_record['fb_sender_id'] = sender_id
                            new_record['Created_time'] = Created_time
                            new_record['Last_changed_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                            new_record['nickname'] = nickname
                            new_record['PS'] = PS
                            new_record['fb_name'] = fb_name
                            new_record['fb_last_name'] = fb_last_name
                            new_record['fb_first_name'] = fb_first_name
                            new_record['pss_win'] = pss_win
                            new_record['pss_lose'] = pss_lose
                            new_record['pss_draw'] = pss_draw
                            doc_ref = db.collection("user_info").document(sender_id)
                            doc_ref.set(new_record)
                        elif msg == 'å¸ƒ' or msg == 'paper' or msg == u'ğŸ–' or msg == u'ğŸ–ğŸ»' or msg == u'ğŸ–ğŸ¼' or msg == u'ğŸ–ğŸ½' or msg == u'ğŸ–ğŸ¾' or msg == u'ğŸ–ğŸ¿' or msg == u'ğŸ¤š' or msg == u'ğŸ¤šğŸ»' or msg == u'ğŸ¤šğŸ¼' or msg == u'ğŸ¤šğŸ½' or msg == u'ğŸ¤šğŸ¾' or msg == u'ğŸ¤šğŸ¿' or msg == u'âœ‹' or msg == u'âœ‹ğŸ»' or msg == u'âœ‹ğŸ¼' or msg == u'âœ‹ğŸ½' or msg == u'âœ‹ğŸ¾' or msg == u'âœ‹ğŸ¿':
                            t = datetime.now().second
                            radm = random.randint(1,t+2)
                            if radm <=13:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'æˆ‘å‡ºå‰ªåˆ€!\nHappy!'
                                elif radmm == 2:
                                    message_to_send = 'å‰ªåˆ€!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = 'Ya!'
                                elif radmm == 3:
                                    message_to_send = 'å‰ªåˆ€:Scissors~\nè´äº†:Win...'
                                elif radmm == 4:
                                    message_to_send = 'æˆ‘å‡ºå‰ªåˆ€ã„ã„'
                                else:
                                    message_to_send = 'å°é¸šéµ¡å‡º....å‰ªåˆ€!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = "èœé›!"
                                pss_lose = str(int(pss_lose)+1)
                            elif radm<=29:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'çŸ³é ­~~\néƒ½æ¬ºè² å°é¸šéµ¡å•Š...'
                                elif radmm == 2:
                                    message_to_send = 'Stone!'
                                    send_message(sender_id,message_to_send)
                                    message_to_send = 'å°é¸šéµ¡é›£é...'
                                elif radmm == 3:
                                    message_to_send = 'å°é¸šéµ¡å‡ºçŸ³é ­~~'
                                elif radmm == 4:
                                    message_to_send = 'çŸ³é ­!\né˜¿ä¸å°±å¥½æ£’æ£’!'
                                elif radmm == 5:
                                    message_to_send = 'å°é¸šéµ¡å‡ºçŸ³é ­~~\nå†ä¾†ä¸€æ¬¡å•Š!!'
                                pss_win = str(int(pss_win)+1)
                            else:
                                radmm = random.randint(1,5)
                                if radmm == 1:
                                    message_to_send = 'å¸ƒ!å¹³æ‰‹è¾£!'
                                elif radmm == 2:
                                    message_to_send = 'æˆ‘å‡ºPaper\nDraw!'
                                elif radmm == 3:
                                    message_to_send = 'Paper!å“¼!'
                                elif radmm == 4:
                                    message_to_send = 'å°é¸šéµ¡å‡ºå¸ƒå‘¦!'
                                elif radmm == 5:
                                    message_to_send = 'P-a-p-p-e-r!å¹³æ‰‹OuO'
                                pss_draw = str(int(pss_draw)+1)
                            new_record = dict()
                            new_record['tnfsh_class'] = tnfsh_class
                            new_record['tnfsh_number'] = tnfsh_number
                            new_record['fb_sender_id'] = sender_id
                            new_record['Created_time'] = Created_time
                            new_record['Last_changed_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                            new_record['nickname'] = nickname
                            new_record['PS'] = PS
                            new_record['fb_name'] = fb_name
                            new_record['fb_last_name'] = fb_last_name
                            new_record['fb_first_name'] = fb_first_name
                            new_record['pss_win'] = pss_win
                            new_record['pss_lose'] = pss_lose
                            new_record['pss_draw'] = pss_draw
                            doc_ref = db.collection("user_info").document(sender_id)
                            doc_ref.set(new_record)
                        elif msg == 'å‰ªåˆ€çŸ³é ­å¸ƒ' or msg == 'paper scissors stone' or msg == 'pss report':
                            win_rate = round(int(pss_win)/(int(pss_win)+int(pss_lose)+0.0000000000001),2)
                            message_to_send = '<å‰ªåˆ€çŸ³é ­å¸ƒç´€éŒ„>\nè´æˆ‘:'+pss_win+'æ¬¡\nè¼¸æˆ‘:'+pss_lose+'æ¬¡\nå¹³æ‰‹:'+pss_draw+'æ¬¡\nå‹ç‡:'+str(win_rate)+'\n'
                            if win_rate < 0.3:
                                radm = random.randint(1,4)
                                if radm == 1:
                                    message_to_send += 'å°é¸šéµ¡è¦ºå¾—ä½ è¶…å«©!'
                                elif radm == 2:
                                    message_to_send += 'æ…˜ä¸å¿ç¹å•Š~'
                                elif radm == 3:
                                    message_to_send += 'èœé›å‡ºç¾!ã„˜ã„Ë‹ã„ã„§'
                                else:
                                    message_to_send += 'å°é¸šéµ¡ç˜‹ç‹‚è´ä½ æ¬¸!'
                            elif win_rate < 0.45:
                                radm = random.randint(1,3)
                                if radm == 1:
                                    mesage_to_send += 'é‚„è¡Œ~é‚„è¡Œ~'
                                elif radm == 2:
                                    message_to_send += 'æ™®æ™®é€šé€š'
                                else:
                                    message_to_send += 'ä½ æ¯”å°é¸šéµ¡çˆ›ä¸€é»ã„ã„'
                            elif win_rate < 0.77:
                                radm = random.randint(1,4)
                                if radm == 1:
                                    message_to_send += 'å¥½åƒå¾ˆå¼·æ¬¸!'
                                elif radm == 2:
                                    message_to_send += 'å°é¸šéµ¡æŠŠä½ ç•¶å°æ‰‹å›‰!'
                                elif radm == 3:
                                    message_to_send += 'é¦¬ä¸Šå°±è¦è¢«æˆ‘æ‰“è¶´ã„Œ'
                                elif radm == 4:
                                    message_to_send += 'å°é¸šéµ¡è¦ºå¾—ä½ æœ‰é»å²å®³ã„Ÿ'
                            elif win_rate < 0.9:
                                radm = random.randint(1,4)
                                if radm == 1:
                                    message_to_send += 'å¤§å¸«!'
                                elif radm == 2:
                                    message_to_send += 'å°é¸šéµ¡ç”˜æ‹œä¸‹é¢¨...'
                                elif radm == 3:
                                    message_to_send += 'å°é¸šéµ¡è¦ºå¾—ä½ è¶…å²å®³'
                                else:
                                    message_to_send += 'å¤ªå¼·äº†å§!!!'
                            else:
                                radm = random.randint(1,4)
                                if radm == 1:
                                    message_to_send += 'å¥½æ™¯ä¸å¸¸çš„'
                                elif radm == 2:
                                    message_to_send += 'æ ¹æœ¬å¤§ç¥ä¾†è‘—!'
                                elif radm == 3:
                                    message_to_send += 'ä½ æ˜¯ä¸æ˜¯çœ‹é€å°é¸šéµ¡çš„å¿ƒäº†...'
                                elif radm == 4:
                                    message_to_send += 'å°é¸šéµ¡æ‹œä½ ç‚ºå¸«~'
                        elif msg[0] == 'c' and len(msg) == 6:  #Change class and number æ›´æ”¹ç­ç´šåº§è™Ÿ
                            try:
                                check_is_number = int(message_text[1:6])
                                
                                if 32000>int(check_is_number)>10099 or int(check_is_number)==66666:

                                    tnfsh_class = message_text[1:4]
                                    tnfsh_number = message_text[4:6]

                                    new_record = dict()
                                    new_record['tnfsh_class'] = tnfsh_class
                                    new_record['tnfsh_number'] = tnfsh_number
                                    new_record['fb_sender_id'] = sender_id
                                    new_record['Created_time'] = Created_time
                                    new_record['Last_changed_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                                    new_record['nickname'] = nickname
                                    new_record['PS'] = PS
                                    new_record['category'] = category
                                    new_record['student_ID'] = student_ID
                                    new_record['true_name'] = true_name
                                    new_record['fb_name'] = fb_name
                                    new_record['fb_profile_pic'] = fb_profile_pic
                                    new_record['fb_last_name'] = fb_last_name
                                    new_record['fb_first_name'] = fb_first_name
                                    new_record['pss_win'] = pss_win
                                    new_record['pss_lose'] = pss_lose
                                    new_record['pss_draw'] = pss_draw
                                    #Sol 1
                                    doc_ref = db.collection("user_info").document(sender_id)
                                    #Sol 2
                                    #doc_path = "/pyradise_students/"+fb_sender_id
                                    #doc_ref = db.document(doc_path)
                                    doc_ref.set(new_record)
                                    message_to_send = tnfsh_class+tnfsh_number+"å·²å®Œæˆæ›´æ”¹"
                            except:
                                message_to_send = 'OAO'
                        elif msg[0:2] == 'ni' and len(message_text) > 2 and message_text[2] != ' ': #Change nickname æ›´æ”¹æš±ç¨±
                            if len(msg)<1903:
                                new_record = dict()
                                new_record['tnfsh_class'] = tnfsh_class
                                new_record['tnfsh_number'] = tnfsh_number
                                new_record['fb_sender_id'] = sender_id
                                new_record['Created_time'] = Created_time
                                new_record['Last_changed_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                                new_record['nickname'] = message_text[2:]
                                new_record['PS'] = PS
                                new_record['fb_name'] = fb_name
                                new_record['fb_last_name'] = fb_last_name
                                new_record['fb_first_name'] = fb_first_name
                                new_record['pss_win'] = pss_win
                                new_record['pss_lose'] = pss_lose
                                new_record['pss_draw'] = pss_draw
                                #Sol 1
                                doc_ref = db.collection("user_info").document(sender_id)
                                #Sol 2
                                #doc_path = "/pyradise_students/"+fb_sender_id
                                #doc_ref = db.document(doc_path)
                                doc_ref.set(new_record)
                                message_to_send = message_text[2:]+"å·²å®Œæˆæ›´æ”¹"
                            else:
                                message_to_send = 'åå­—å¤ªé•·å›‰~(æœ€å¤š1900å­—)'
                        elif msg[0:3] == 'set' and 3 < len(msg) < 11 and (msg.find('1') != -1 or msg.find('2') != -1 or msg.find('3') != -1 or msg.find('4') != -1 or msg.find('5') != -1 or msg.find('6') != -1 or msg.find('7') != -1 or msg.find('0')!=-1): #è¨­å®šæ˜ŸæœŸå¹¾å»£æ’­
                            message_to_send = 'è™•ç†ä¸­...'
                            send_message(sender_id, message_to_send)
                            #Add to total_list
                            total_list_doc_ref = db.collection("total_list").document('total1')
                            total_docs = total_list_doc_ref.get()
                            fb_sender_id_list = format(total_docs.to_dict()['fb_sender_id_list'])
                            fb_sender_id_list_week1 = format(total_docs.to_dict()['fb_sender_id_list_week1'])
                            fb_sender_id_list_week2 = format(total_docs.to_dict()['fb_sender_id_list_week2'])
                            fb_sender_id_list_week3 = format(total_docs.to_dict()['fb_sender_id_list_week3'])
                            fb_sender_id_list_week4 = format(total_docs.to_dict()['fb_sender_id_list_week4'])
                            fb_sender_id_list_week5 = format(total_docs.to_dict()['fb_sender_id_list_week5'])
                            fb_sender_id_list_week6 = format(total_docs.to_dict()['fb_sender_id_list_week6'])
                            fb_sender_id_list_week7 = format(total_docs.to_dict()['fb_sender_id_list_week7'])
                            if msg.find('1') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰1
                                fb_sender_id_list_week1 = fb_sender_id_list_week1.replace(','+sender_id,'')
                            else: #setæŒ‡ä»¤ä¸­æœ‰1
                                if fb_sender_id_list_week1.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week1 = fb_sender_id_list_week1 + ',' + sender_id
                            if msg.find('2') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰2
                                fb_sender_id_list_week2 = fb_sender_id_list_week2.replace(','+sender_id,'')
                            else:
                                if fb_sender_id_list_week2.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week2 = fb_sender_id_list_week2 + ',' + sender_id
                            if msg.find('3') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰3
                                fb_sender_id_list_week3 = fb_sender_id_list_week3.replace(','+sender_id,'')
                            else:
                                if fb_sender_id_list_week3.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week3 = fb_sender_id_list_week3 + ',' + sender_id
                            if msg.find('4') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰4
                                fb_sender_id_list_week4 = fb_sender_id_list_week4.replace(','+sender_id,'')
                            else:
                                if fb_sender_id_list_week4.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week4 = fb_sender_id_list_week4 + ',' + sender_id
                            if msg.find('5') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰5
                                fb_sender_id_list_week5 = fb_sender_id_list_week5.replace(','+sender_id,'')
                            else:
                                if fb_sender_id_list_week5.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week5 = fb_sender_id_list_week5 + ',' + sender_id
                            if msg.find('6') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰6
                                fb_sender_id_list_week6 = fb_sender_id_list_week6.replace(','+sender_id,'')
                            else:
                                if fb_sender_id_list_week6.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week6 = fb_sender_id_list_week6 + ',' + sender_id
                            if msg.find('7') == -1: #setæŒ‡ä»¤ä¸­æ²’æœ‰7
                                fb_sender_id_list_week7 = fb_sender_id_list_week7.replace(','+sender_id,'')
                            else:
                                if fb_sender_id_list_week7.find(sender_id) == -1: #æœ¬ä¾†é€™å¤©æ²’æœ‰è¦å»£æ’­ã„Œ #å¦‚æœæœ¬ä¾†æœ‰è¦å»£æ’­å°±ä¸å‹•
                                    fb_sender_id_list_week7 = fb_sender_id_list_week7 + ',' + sender_id
                            total_list_new_record = dict()
                            total_list_new_record['fb_sender_id_list'] = fb_sender_id_list
                            total_list_new_record['fb_sender_id_list_week1'] = fb_sender_id_list_week1
                            total_list_new_record['fb_sender_id_list_week2'] = fb_sender_id_list_week2
                            total_list_new_record['fb_sender_id_list_week3'] = fb_sender_id_list_week3
                            total_list_new_record['fb_sender_id_list_week4'] = fb_sender_id_list_week4
                            total_list_new_record['fb_sender_id_list_week5'] = fb_sender_id_list_week5
                            total_list_new_record['fb_sender_id_list_week6'] = fb_sender_id_list_week6
                            total_list_new_record['fb_sender_id_list_week7'] = fb_sender_id_list_week7
                            total_list_doc_ref.set(total_list_new_record)
                            message_to_send = msg + 'è¨­å®šå®Œæˆ'
                        elif msg.find('profile') != -1: # Check profile æŸ¥è©¢å€‹äººè¨­å®š
                            message_to_send = '<å€‹äººè¨­å®šæª”>\næš±ç¨±: ' + nickname + '\nç­ç´š: ' + tnfsh_class + '\nåº§è™Ÿ: ' + tnfsh_number
                        elif (msg.find('*') != -1 or msg.find('/') != -1) and len(msg) < 12 and msg.find('**') == -1: #Easy Calculator ç°¡å–®çš„è¨ˆç®—æ©Ÿ
                            try:
                                radm = random.randint(1,3)
                                if radm == 1:
                                    message_to_send = 'æ‡‰è©²æ˜¯... ' + str(eval(msg)) + 'å§!'
                                elif radm == 2:
                                    message_to_send = str(eval(msg)) + '\nè°æ˜å§!'
                                elif radm == 3:
                                    message_to_send = str(eval(msg))
                            except:
                                pass
                        elif msg.find('**') != -1 and len(msg) < 5:
                            try:
                                radm = random.randint(1,3)
                                if radm == 1:
                                    message_to_send = 'æ‡‰è©²æ˜¯... ' + str(eval(msg)) + 'å§!'
                                elif radm == 2:
                                    message_to_send = str(eval(msg)) + '\nè°æ˜å§!'
                                elif radm == 3:
                                    message_to_send = str(eval(msg))
                            except:
                                pass
                        elif (msg.find('+') != -1 or msg.find('-') != -1) and len(msg) < 21:
                            try:
                                radm = random.randint(1,3)
                                if radm == 1:
                                    message_to_send = 'æ‡‰è©²æ˜¯... ' + str(eval(msg)) + 'å§!'
                                elif radm == 2:
                                    message_to_send = str(eval(msg)) + '\nè°æ˜å§!'
                                elif radm == 3:
                                    message_to_send = str(eval(msg))
                            except:
                                pass                      
                        elif msg.find('å°é¸šéµ¡') != -1:
                            radm = random.randint(1,5)
                            if radm == 1:
                                message_to_send = 'å°é¸šéµ¡åœ¨æ­¤ç‚ºæ‚¨æœå‹™!'
                            elif radm == 2:
                                message_to_send = 'è®šè¾£!'
                            elif radm == 3:
                                message_to_send = 'æ­£åœ¨åŠªåŠ›å­¸ç¿’ä¸­~~'
                            elif radm == 4:
                                message_to_send = 'æ˜¯æˆ‘çš„åå­—å‘¦!'
                            elif radm == 5:
                                message_to_send = nickname + '~~'
                        elif msg == 'time':
                            message_to_send = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                        elif msg == 'date':
                            message_to_send = datetime.now().date().strftime("%Y-%m-%d")
                        else: #Can't recognize ç„¡æ³•è¾¨è­˜çš„è©±
                            radm = random.randint(1,15)
                            if radm > 13:
                                message_to_send = 'å°é¸šéµ¡ç„¡è¨€ä»¥å°...'
                            elif radm > 9:
                                message_to_send = "ã„›\nå¹²æˆ‘"
                            elif radm > 7:
                                message_to_send = message_text + "\né˜¿ä¸å°±å¥½æ£’æ£’?"
                            elif radm > 6:
                                message_to_send = "å¾ˆé…·ã„›"
                            elif radm > 5:
                                message_to_send = "ã„›å¥½å‘¦"
                            elif radm > 4:
                                message_to_send = message_text + "\nSounds good!"
                            else:
                                message_to_send = message_text
                    elif is_member_ed == False: #Not a member éæœƒå“¡
                        if is_number(message_text):
                            if 32000>int(message_text)>10099:
                                tnfsh_class = message_text[0:3]
                                tnfsh_number = message_text[3:5]

                                new_record = dict()
                                new_record['tnfsh_class'] = tnfsh_class
                                new_record['tnfsh_number'] = tnfsh_number
                                new_record['fb_sender_id'] = sender_id
                                new_record['Created_time'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                                new_record['PS'] = ''
                                new_record['nickname'] = tnfsh_class + tnfsh_number
                                new_record['Last_changed_time'] = 'None'
                                new_record['pss_win'] = "0"
                                new_record['pss_lose'] = "0"
                                new_record['pss_draw'] = "0"
                                try:
                                    info = user_info_query(sender_id)
                                    new_record['fb_name'] = info['name']
                                    new_record['fb_last_name'] = info['last_name']
                                    new_record['fb_first_name'] = info['first_name']
                                except:
                                    new_record['fb_name'] = ""
                                    new_record['fb_last_name'] = ''
                                    new_record['fb_first_name'] = ''
                                #Create new record å»ºç«‹æ–°è³‡æ–™
                                doc_ref = db.collection("user_info").document(sender_id)
                                doc_ref.set(new_record)
                                
                                #send a message first
                                message_to_send = 'è™•ç†ä¸­...'
                                send_message(sender_id, message_to_send)
                                #Add to total_list
                                total_list_doc_ref = db.collection("total_list").document('total1')
                                total_docs = total_list_doc_ref.get()
                                fb_sender_id_list = format(total_docs.to_dict()['fb_sender_id_list'])
                                fb_sender_id_list_week1 = format(total_docs.to_dict()['fb_sender_id_list_week1'])
                                fb_sender_id_list_week2 = format(total_docs.to_dict()['fb_sender_id_list_week2'])
                                fb_sender_id_list_week3 = format(total_docs.to_dict()['fb_sender_id_list_week3'])
                                fb_sender_id_list_week4 = format(total_docs.to_dict()['fb_sender_id_list_week4'])
                                fb_sender_id_list_week5 = format(total_docs.to_dict()['fb_sender_id_list_week5'])
                                fb_sender_id_list_week6 = format(total_docs.to_dict()['fb_sender_id_list_week6'])
                                fb_sender_id_list_week7 = format(total_docs.to_dict()['fb_sender_id_list_week7'])

                                fb_sender_id_list += ','+sender_id
                                fb_sender_id_list_week1 += ','+sender_id
                                fb_sender_id_list_week2 += ','+sender_id
                                fb_sender_id_list_week3 += ','+sender_id
                                fb_sender_id_list_week4 += ','+sender_id
                                fb_sender_id_list_week5 += ','+sender_id
                                fb_sender_id_list_week6 += ','+sender_id
                                fb_sender_id_list_week7 += ','+sender_id

                                total_list_new_record = dict()
                                total_list_new_record['fb_sender_id_list'] = fb_sender_id_list
                                total_list_new_record['fb_sender_id_list_week1'] = fb_sender_id_list_week1
                                total_list_new_record['fb_sender_id_list_week2'] = fb_sender_id_list_week2
                                total_list_new_record['fb_sender_id_list_week3'] = fb_sender_id_list_week3
                                total_list_new_record['fb_sender_id_list_week4'] = fb_sender_id_list_week4
                                total_list_new_record['fb_sender_id_list_week5'] = fb_sender_id_list_week5
                                total_list_new_record['fb_sender_id_list_week6'] = fb_sender_id_list_week6
                                total_list_new_record['fb_sender_id_list_week7'] = fb_sender_id_list_week7
                                total_list_doc_ref.set(total_list_new_record)

                                message_to_send = tnfsh_class+tnfsh_number+'å·²å®Œæˆç¶å®š'
                                send_message(sender_id, message_to_send)
                                message_to_send = 'è¼¸å…¥helpå–å¾—èªªæ˜'
                            else:
                                message_to_send = 'æ‚¨å°šæœªç¶å®šç­ç´šåº§è™Ÿï¼Œè«‹è¼¸å…¥æ‚¨çš„ç­ç´šåº§è™Ÿå…±äº”ä½æ•¸(e.g.20101)'
                        else:
                            message_to_send = 'æ‚¨å°šæœªç¶å®šç­ç´šåº§è™Ÿï¼Œè«‹è¼¸å…¥æ‚¨çš„ç­ç´šåº§è™Ÿå…±äº”ä½æ•¸(e.g.10101)'
                    else:
                        message_to_send = 'OuO'
                    try:
                        send_message(sender_id, message_to_send)
                    except:
                        send_message(sender_id, 'QAQ')
                if messaging_event.get("delivery"):  # delivery confirmation
                    pass
                if messaging_event.get("optin"):  # optin confirmation
                    pass
                if messaging_event.get("postback"):  # user clicked/tapped "postback" button in earlier message é€éæŒ‰éˆ•éè¨Šæ¯æ¡†
                    #pass
                    #check if it is member
                    try:  #Check if it is a member, if true record its info
                        #log("search member")
                        sender_id = messaging_event['sender']['id']        # the facebook ID of the person sending you the message
                        recipient_id = messaging_event['recipient']['id']  # the recipient's ID, which should be your page's facebook ID                    
                        doc_ref = user_info_collection_ref.document(sender_id)
                        docs_dict = doc_ref.get().to_dict()
                        tnfsh_class = format(docs_dict['tnfsh_class'])
                        tnfsh_number = format(docs_dict['tnfsh_number'])
                        Created_time = format(docs_dict['Created_time'])
                        nickname = format(docs_dict['nickname'])
                        PS = format(docs_dict['PS'])
                        #print(docs)
                        #log(docs)
                        is_member_ed = True
                    except:  #Not a member
                        is_member_ed = False
                    payload = messaging_event['postback']['payload']
                    if (payload == 'get_started' and is_member_ed == False) or is_member_ed == False:
                        message_to_send = 'è«‹è¼¸å…¥ç­ç´šåº§è™Ÿä»¥å®Œæˆç¶å®š\n(e.g.10101)'
                    else:
                        if payload == 'qw' or payload == 'æŸ¥è©¢æœ¬å‘¨' or payload == 'æŸ¥è©¢æœ¬é€±':
                            weekday = date.today().isoweekday()   
                            count_absent_total, count_late_total, count_leave_total = absent_query_period(tnfsh_class, tnfsh_number, (datetime.now() + timedelta(days = -weekday+1)).strftime("%Y-%m-%d"), datetime.now().date().strftime("%Y-%m-%d"))                            
                            message_to_send = '<æ‚¨çš„æœ¬é€±ç¼ºå¸­>\n'
                            if count_absent_total == 0:
                                message_to_send += 'æŸ¥ç„¡æœ¬é€±ç¼ºå¸­\n'
                            else:
                                message_to_send += 'æœ¬é€±å…±ç¼ºå¸­'+str(count_absent_total)+'ç¯€\n'
                            if count_late_total > 0:
                                message_to_send += 'æœ¬é€±å…±é²åˆ°'+str(count_late_total)+'ç¯€\n'
                            if count_leave_total > 0:
                                message_to_send += 'æœ¬å‘¨å…±æ—©é€€'+str(count_leave_total)+'ç¯€\n'
                            if count_absent_total + count_late_total + count_leave_total > 0:
                                message_to_send += 'å¿«å»çœ‹çœ‹å“ªç¯€èª²è¢«è¨˜å§!\n'
                                message_to_send += shorten_url('https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+(datetime.now() + timedelta(days = -weekday+1)).strftime("%Y-%m-%d")+'&end='+datetime.now().date().strftime("%Y-%m-%d")+'&class='+tnfsh_class+'&num='+tnfsh_number)
                        elif payload == 'q' or payload == 'æŸ¥è©¢æœ€è¿‘':
                            date_today = datetime.now().date().strftime("%Y-%m-%d")
                            date_p1 = (datetime.now() + timedelta(days = -1)).strftime("%Y-%m-%d")
                            date_p2 = (datetime.now() + timedelta(days = -2)).strftime("%Y-%m-%d")
                            #Check today
                            count_absent_today, count_late_today, count_leave_today = absent_query(tnfsh_class, tnfsh_number, date_today)
                            #Check p1 day
                            count_absent_p1, count_late_p1, count_leave_p1 = absent_query(tnfsh_class, tnfsh_number, date_p1)
                            #Check p2 day
                            count_absent_p2, count_late_p2, count_leave_p2 = absent_query(tnfsh_class, tnfsh_number, date_p2)
                            #Deal message_to_send
                            message_to_send = '<æ‚¨çš„æœ€è¿‘ç¼ºå¸­>\n'
                            if count_absent_today == 0:
                                message_to_send += 'æŸ¥ç„¡æœ¬æ—¥ç¼ºå¸­\n'
                            else:
                                message_to_send += 'ä½ ä»Šå¤©å…±ç¼ºå¸­'+str(count_absent_today)+'ç¯€èª²\n'
                            if count_late_today > 0:
                                message_to_send += 'ä½ ä»Šå¤©å…±é²åˆ°'+str(count_late_today)+'ç¯€èª²\n'
                            if count_leave_today > 0:
                                message_to_send += 'ä½ ä»Šå¤©å…±æ—©é€€'+str(count_leave_today)+'ç¯€èª²\n'
                            if count_absent_p1 == 0:
                                message_to_send += 'æŸ¥ç„¡æ˜¨å¤©ç¼ºå¸­\n'
                            else:
                                message_to_send += 'ä½ æ˜¨å¤©å…±ç¼ºå¸­'+str(count_absent_p1)+'ç¯€èª²\n'
                            if count_late_p1 > 0:
                                message_to_send += 'ä½ æ˜¨å¤©å…±é²åˆ°'+str(count_late_p1)+'ç¯€èª²\n'
                            if count_leave_p1 >0:
                                message_to_send += 'ä½ æ˜¨å¤©å…±æ—©é€€'+str(count_leave_p1)+'ç¯€èª²\n'
                            if count_absent_p2 == 0:
                                message_to_send += 'æŸ¥ç„¡å‰å¤©ç¼ºå¸­\n'
                            else:
                                message_to_send += 'ä½ å‰å¤©å…±ç¼ºå¸­'+str(count_absent_p2)+'ç¯€èª²\n'
                            if count_late_p2 > 0:
                                message_to_send += 'ä½ å‰å¤©å…±é²åˆ°'+str(count_late_p2)+'ç¯€èª²\n'
                            if count_leave_p2 > 0:
                                message_to_send += 'ä½ å‰å¤©å…±æ—©é€€'+str(count_leave_p2)+'ç¯€èª²\n'
                            if count_absent_today + count_late_today + count_leave_today + count_absent_p1 + count_late_p1 + count_leave_p1 + count_absent_p2 + count_late_p2 + count_leave_p2 >0 :
                                message_to_send += 'å¿«å»çœ‹çœ‹å“ªç¯€èª²è¢«è¨˜å§!\n'
                                message_to_send += shorten_url('https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+date_p2+'&end='+date_today+'&class='+tnfsh_class+'&num='+tnfsh_number)
                        elif payload == 'course': #æˆ‘çš„èª²è¡¨æŒ‰éˆ•
                            message_to_send = ""
                            send_image_message(sender_id, "https://tnfsh-absentee.web.app/courseTables/"+tnfsh_class+".jpeg")
                        elif payload == 'help' or is_member_ed == True:
                            message_to_send = 'æŸ¥è©¢è¿‘ä¸‰æ—¥ç¼ºå¸­: q æˆ– æŸ¥è©¢æœ€è¿‘\næŸ¥è©¢æœ¬å‘¨ç¼ºå¸­: qw æˆ– æŸ¥è©¢æœ¬é€±\né‡è¨­ç­ç´šåº§è™Ÿ: cç­ç´šåº§è™Ÿ (e.g. c10101)\nè¨­å®šæš±ç¨±:ni+æš±ç¨± (e.g. niå¤©å ‚)\næŸ¥è©¢å€‹äººè¨­å®š:profile\né¡¯ç¤ºèª²è¡¨:course'
                            send_message(sender_id,message_to_send)
                            message_to_send = 'æŸ¥è©¢æŒ‡å®šå€é–“: q+èµ·å§‹çµæŸè¥¿å…ƒå¹´æœˆæ—¥\n(e.g. q2018010120190331)\nè¨­å®šæ˜ŸæœŸå¹¾è¦æ¨æ’­æ™šå®‰è¨Šæ¯:\nset+æ”¶æ¨æ’­çš„æ˜ŸæœŸå¹¾\n(e.g. æ˜ŸæœŸäºŒå››å…­æ—¥ set2467)'
                            send_message(sender_id, message_to_send)
                            message_to_send = 'ä¹Ÿå¯ä»¥è·Ÿæˆ‘say hi ã„›~~'
                            send_message(sender_id, message_to_send)
                            message_to_send = 'åƒæ˜¯1+1ä¹‹é¡ç°¡å–®çš„æ•¸å­¸æˆ‘å…¶å¯¦ä¹Ÿæœƒç®—!\næƒ³è·Ÿæˆ‘ç©éŠæˆ²çš„è©±å°±è¼¸å…¥gamehelpå§!'                   
                    send_message(sender_id, message_to_send)
    return "ok", 200

def send_to_all(message_text):
    total_list_doc_ref = db.collection('total_list').document('total1')
    total_docs = total_list_doc_ref.get()
    fb_sender_id_list = format(total_docs.to_dict()['fb_sender_id_list'])
    to_send_list = fb_sender_id_list.split(',')
    for recipient_id in to_send_list:
        send_message(recipient_id, message_text)

def send_message(recipient_id, message_text):

    log("sending message to {recipient}: {text}".format(recipient=recipient_id, text=message_text))

    params = {
        "access_token": os.environ["PAGE_ACCESS_TOKEN"]
    }
    headers = {
        "Content-Type": "application/json"
    }
    data = json.dumps({
        "recipient": {
            "id": recipient_id
        },
        "message": {
            "text": message_text
        }
    })
    r = requests.post("https://graph.facebook.com/v2.6/me/messages", params=params, headers=headers, data=data)
    if r.status_code != 200:
        print(r.status_code)
        print(r.text)
def send_image_message(recipient_id, image_url):

    log("sending message to {recipient}: {text}".format(recipient=recipient_id, text="send_image_message"))

    params = {
        "access_token": os.environ["PAGE_ACCESS_TOKEN"]
    }
    headers = {
        "Content-Type": "application/json"
    }
    data = json.dumps({
        "recipient": {
            "id": recipient_id
        },
        "message": {
            "attachment":{
                "type":"image", 
                "payload":{
                    "url": image_url, 
                    "is_reusable":True
      }
    }
        }
    })
    r = requests.post("https://graph.facebook.com/v2.6/me/messages", params=params, headers=headers, data=data)
    if r.status_code != 200:
        print(r.status_code)
        print(r.text)

def absent_query(tnfsh_class, tnfsh_number, day):  #Query single day
    url = 'https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+day+'&end='+day+'&class='+tnfsh_class+'&num='+tnfsh_number
    html = urllib.request.urlopen(url).read()
    count_absent = str(html).count('btn-danger')
    count_late = str(html).count('btn-warning')
    count_leave = str(html).count('btn-info')
    return count_absent, count_late, count_leave    

def absent_query_period(tnfsh_class, tnfsh_number, str_day, end_day):  #Query a period
    url = 'https://sp.tnfsh.tn.edu.tw/attend/index.php/attend/search?begin='+str_day+'&end='+end_day+'&class='+tnfsh_class+'&num='+tnfsh_number
    html = urllib.request.urlopen(url).read()
    count_absent = str(html).count('btn-danger')
    count_late = str(html).count('btn-warning')
    count_leave = str(html).count('btn-info')
    return count_absent, count_late, count_leave    

def log(msg, *args, **kwargs):  # simple wrapper for logging to stdout on heroku
    try:
        if type(msg) is dict:
            msg = json.dumps(msg)
        else:
            #msg = 'sorry'
            msg = msg.format(*args, **kwargs)  #é€™è£¡æ”¹é!!åŸç‚ºunicode(msg).format~
        print(u"{}: {}".format(datetime.now(), msg))
    except UnicodeEncodeError:
        pass  # squash logging errors in case of non-ascii text
    sys.stdout.flush()

def is_number(s): #check if it is a interger
    try:
        int(s)
        return True
    except ValueError:
        pass
 
    try:
        import unicodedata
        unicodedata.numeric(s)
        return True
    except (TypeError, ValueError):
        pass
 
    return False

def shorten_url(longurl):
    s = pyshorteners.Shortener(Shorteners.TINYURL)
    shorturl = s.short(longurl)
    #Put your tinyurl info here å°‡tinyurlè³‡è¨Šæ”¾æ–¼æ­¤
    url_shortener = UrlShortener('TINYURL_Token', 'TINYURL_Name')
    shorten_url = url_shortener.get_short_link(shorturl)
    
    return shorten_url
def user_info_query(recipient_id):

    #log("sending btn message to all: ")

    params = {
        # Access Token from Facebook
        # Facebookæä¾›ä¹‹Access Token
        "access_token": 'ACCESS_TOKEN',
        "fields": "first_name,name,last_name,profile_pic"
    }
    headers = {
        "Content-Type": "application/json"
    }
    r = requests.get("https://graph.facebook.com/"+recipient_id, params=params, headers=headers)       
    if r.status_code != 200:
        print('æ–¼æŸ¥è©¢'+recipient_id+'æ™‚å‡ºç¾éŒ¯èª¤:',end='')
        print(r.status_code)
        print(r.text)
    return r.json()

if __name__ == '__main__':
    app.run(debug=True)